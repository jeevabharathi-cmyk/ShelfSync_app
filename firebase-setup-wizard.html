<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShelfSync | Firebase Setup Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .wizard-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .wizard-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .wizard-header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .wizard-body {
            padding: 40px;
        }

        .step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .status-card {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .status-card.success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .status-card.error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .status-card.warning {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }

        .status-card.info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #0d47a1;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .instruction-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .instruction-list li {
            margin: 15px 0;
            line-height: 1.6;
        }

        .instruction-list strong {
            color: #667eea;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .log-output {
            background: #1e1e1e;
            color: #4caf50;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            display: none;
        }

        .log-output.visible {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .link-button {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .link-button:hover {
            text-decoration: underline;
        }

        .emoji {
            font-size: 24px;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div class="wizard-container">
        <div class="wizard-header">
            <h1>üî• Firebase Setup Wizard</h1>
            <p>Let's get your ShelfSync Firebase backend ready!</p>
        </div>

        <div class="wizard-body">
            <!-- Step 1: Checking Firebase Connection -->
            <div class="step active" id="step1">
                <h2 class="step-title">Step 1: Checking Firebase Connection</h2>
                <div id="connectionStatus" class="status-card info">
                    <span class="loading"></span> Checking Firebase configuration...
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="checkFirebase()" id="checkBtn">Recheck Connection</button>
                </div>
            </div>

            <!-- Step 2: Database Setup Instructions -->
            <div class="step" id="step2">
                <h2 class="step-title">Step 2: Create Firestore Database</h2>
                <div class="status-card warning">
                    <span class="emoji">‚ö†Ô∏è</span>
                    <strong>Firestore database not found!</strong>
                    <p style="margin-top: 10px;">You need to create a Firestore database in your Firebase Console.</p>
                </div>

                <div class="instruction-list">
                    <h3 style="margin-bottom: 15px;">Follow these steps:</h3>
                    <ol>
                        <li>
                            <strong>Open Firebase Console:</strong><br>
                            <a href="https://console.firebase.google.com/project/shelfsync-6fedf/firestore"
                                target="_blank" class="link-button">
                                Click here to open Firebase Console
                            </a>
                        </li>
                        <li>
                            <strong>Click "Create Database"</strong> button
                        </li>
                        <li>
                            <strong>Choose location:</strong> Select "nam5 (us-central)" or closest to you
                        </li>
                        <li>
                            <strong>Security rules:</strong> Select <strong>"Start in test mode"</strong><br>
                            <small>(You can change this later for production)</small>
                        </li>
                        <li>
                            <strong>Click "Enable"</strong> and wait for database creation (1-2 minutes)
                        </li>
                    </ol>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showStep(1)">Back</button>
                    <button class="btn btn-primary" onclick="showStep(3)">I've Created the Database</button>
                </div>
            </div>

            <!-- Step 3: Verify Database and Create User Profile -->
            <div class="step" id="step3">
                <h2 class="step-title">Step 3: Setup User Profile</h2>
                <div class="status-card info">
                    <span class="emoji">üë§</span>
                    <strong>Creating your user profile in Firestore</strong>
                    <p style="margin-top: 10px;">This will allow you to log in to the application.</p>
                </div>

                <div id="userSetupStatus"></div>
                <div id="logOutput" class="log-output"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showStep(2)">Back</button>
                    <button class="btn btn-primary" onclick="setupUserProfile()" id="setupBtn">Create User
                        Profile</button>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div class="step" id="step4">
                <h2 class="step-title">‚úÖ Setup Complete!</h2>
                <div class="status-card success">
                    <span class="emoji">üéâ</span>
                    <strong>Your Firebase backend is ready!</strong>
                    <p style="margin-top: 10px;">You can now log in to ShelfSync with your credentials.</p>
                </div>

                <div class="instruction-list">
                    <h3 style="margin-bottom: 15px;">What's Next?</h3>
                    <ul style="list-style: none;">
                        <li>‚úÖ Firebase is configured and running</li>
                        <li>‚úÖ Firestore database is created</li>
                        <li>‚úÖ Your user profile is set up</li>
                        <li style="margin-top: 15px;">
                            <strong>Now you can:</strong><br>
                            <a href="pages/login-seller.html" class="link-button">Go to Seller Login ‚Üí</a>
                        </li>
                    </ul>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="window.location.href='pages/login-seller.html'">
                        Go to Login Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, createUserWithEmailAndPassword } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from 'firebase/firestore';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDfyqcchPmY0MvKCaJQmwP0ILyf9UODMis",
            authDomain: "shelfsync-6fedf.firebaseapp.com",
            projectId: "shelfsync-6fedf",
            storageBucket: "shelfsync-6fedf.firebasestorage.app",
            messagingSenderId: "328141524902",
            appId: "1:328141524902:web:5616c7b58d48deda3f0967",
            measurementId: "G-2SSZLVQ1Z8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make available globally
        window.auth = auth;
        window.db = db;
        window.firebaseApp = app;

        // Auto-check on load
        setTimeout(checkFirebase, 1000);

        // Step navigation
        window.showStep = function (stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step' + stepNumber).classList.add('active');
        };

        // Log function
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            logOutput.classList.add('visible');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚Üí';
            logOutput.innerHTML += `<div>[${timestamp}] ${prefix} ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Check Firebase connection
        window.checkFirebase = async function () {
            const statusDiv = document.getElementById('connectionStatus');
            const checkBtn = document.getElementById('checkBtn');

            checkBtn.disabled = true;
            statusDiv.innerHTML = '<span class="loading"></span> Checking Firebase connection...';
            statusDiv.className = 'status-card info';

            try {
                // Test Firestore connection by trying to read a document
                const testDoc = doc(db, '_test', 'connection');
                await getDoc(testDoc);

                // If we get here, Firestore is working
                statusDiv.innerHTML = `
                    <span class="emoji">‚úÖ</span>
                    <strong>Firebase Connected!</strong>
                    <p style="margin-top: 10px;">Your Firebase configuration is working correctly.</p>
                `;
                statusDiv.className = 'status-card success';

                setTimeout(() => showStep(3), 1500);

            } catch (error) {
                console.error('Firebase check error:', error);

                if (error.code === 'permission-denied' ||
                    error.message.includes('Missing or insufficient permissions')) {
                    // Database exists but rules might be restrictive - this is actually OK
                    statusDiv.innerHTML = `
                        <span class="emoji">‚úÖ</span>
                        <strong>Firebase Connected!</strong>
                        <p style="margin-top: 10px;">Database exists. Moving to user setup...</p>
                    `;
                    statusDiv.className = 'status-card success';
                    setTimeout(() => showStep(3), 1500);

                } else if (error.message.includes('database (default) does not exist') ||
                    error.message.includes('client is offline')) {
                    // Database doesn't exist
                    statusDiv.innerHTML = `
                        <span class="emoji">‚ö†Ô∏è</span>
                        <strong>Firestore Database Not Found</strong>
                        <p style="margin-top: 10px;">You need to create the database first.</p>
                    `;
                    statusDiv.className = 'status-card warning';
                    setTimeout(() => showStep(2), 1500);

                } else {
                    // Other error
                    statusDiv.innerHTML = `
                        <span class="emoji">‚ùå</span>
                        <strong>Connection Error</strong>
                        <p style="margin-top: 10px;">${error.message}</p>
                    `;
                    statusDiv.className = 'status-card error';
                }
            } finally {
                checkBtn.disabled = false;
            }
        };

        // Setup user profile
        window.setupUserProfile = async function () {
            const setupBtn = document.getElementById('setupBtn');
            const statusDiv = document.getElementById('userSetupStatus');

            setupBtn.disabled = true;
            setupBtn.textContent = 'Setting up...';

            log('Starting user profile setup...');

            try {
                const email = 'jackdoe628@gmail.com';
                const password = 'TestPassword123';

                log(`Checking if user ${email} already exists...`);

                // Try to create the user or sign in if exists
                let user;
                try {
                    log('Attempting to create new user account...');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    user = userCredential.user;
                    log(`User account created successfully! UID: ${user.uid}`, 'success');
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        log('User already exists, that\'s OK!', 'success');
                        // User already exists, get current user
                        user = auth.currentUser;
                        if (!user) {
                            throw new Error('Please log in first with your credentials');
                        }
                    } else {
                        throw authError;
                    }
                }

                // Create seller profile in Firestore
                log('Creating seller profile in Firestore...');
                const sellerData = {
                    email: email,
                    role: 'seller',
                    storeName: 'My Bookstore',
                    verified: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                await setDoc(doc(db, 'sellers', user.uid), sellerData);
                log('Seller profile created in Firestore!', 'success');

                // Verify it was created
                log('Verifying profile...');
                const sellerDoc = await getDoc(doc(db, 'sellers', user.uid));

                if (sellerDoc.exists()) {
                    log('Profile verified successfully!', 'success');
                    log(`Profile data: ${JSON.stringify(sellerDoc.data(), null, 2)}`);

                    statusDiv.innerHTML = `
                        <div class="status-card success">
                            <span class="emoji">‚úÖ</span>
                            <strong>User Profile Created!</strong>
                            <p style="margin-top: 10px;">
                                Email: ${email}<br>
                                Password: ${password}<br>
                                Role: Seller
                            </p>
                        </div>
                    `;

                    setTimeout(() => showStep(4), 2000);
                } else {
                    throw new Error('Profile verification failed');
                }

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error('Setup error:', error);

                let errorMessage = error.message;
                if (error.code === 'permission-denied') {
                    errorMessage = 'Permission denied. Make sure Firestore is in Test Mode.';
                }

                statusDiv.innerHTML = `
                    <div class="status-card error">
                        <span class="emoji">‚ùå</span>
                        <strong>Setup Failed</strong>
                        <p style="margin-top: 10px;">${errorMessage}</p>
                    </div>
                `;

                setupBtn.disabled = false;
                setupBtn.textContent = 'Retry Setup';
            }
        };
    </script>
</body>

</html>