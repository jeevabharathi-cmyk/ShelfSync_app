<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Book | ShelfSync</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .dashboard-sidebar {
            background-color: #0f172a;
        }

        .add-book-layout {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: var(--spacing-xl);
            align-items: start;
        }

        .add-book-card {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .add-book-card-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .add-book-card-title {
            margin: 0;
            font-size: 1.125rem;
            color: var(--secondary-color);
            font-weight: 800;
        }

        .add-book-card-subtitle {
            margin: var(--spacing-xs) 0 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .add-book-card-body {
            padding: var(--spacing-lg);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .form-grid .span-2 {
            grid-column: 1 / -1;
        }

        .help-text {
            margin-top: var(--spacing-xs);
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 0.25rem 0.6rem;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            background: rgba(44, 82, 130, 0.06);
            color: var(--secondary-color);
            font-weight: 600;
            white-space: nowrap;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            background: rgba(15, 23, 42, 0.02);
            transition: border-color var(--transition-base), box-shadow var(--transition-base), transform var(--transition-base);
        }

        .upload-zone.dragover {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(196, 86, 33, 0.12);
            transform: translateY(-1px);
        }

        .upload-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .preview-tile {
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-light);
            background: #0f172a;
            aspect-ratio: 3 / 4;
        }

        .preview-tile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            opacity: 0.95;
        }

        .preview-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
        }

        .meta-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }

        .meta-item {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            background: rgba(44, 82, 130, 0.03);
        }

        .meta-title {
            font-weight: 800;
            color: var(--secondary-color);
            margin: 0 0 var(--spacing-sm);
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            padding: 0.4rem 0;
            border-bottom: 1px dashed rgba(15, 23, 42, 0.12);
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .meta-row:last-child {
            border-bottom: none;
        }

        .meta-row strong {
            color: var(--secondary-color);
            font-weight: 700;
        }

        .actions-bar {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .toast {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: min(420px, calc(100vw - 36px));
            background: var(--surface-color);
            border: 1px solid var(--border-light);
            border-left: 6px solid var(--success-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-md);
            display: none;
            z-index: 9999;
        }

        .toast.show {
            display: block;
            animation: slideInRight 0.4s ease-out;
        }

        .toast-title {
            font-weight: 800;
            color: var(--secondary-color);
            margin: 0 0 var(--spacing-xs);
        }

        .toast-msg {
            color: var(--text-light);
            margin: 0;
        }

        .error-text {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: var(--spacing-xs);
            display: none;
        }

        .form-control.invalid {
            border-color: var(--error-color);
            box-shadow: 0 0 0 4px rgba(229, 62, 62, 0.12);
        }

        @media (max-width: 1024px) {
            .add-book-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .upload-preview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <a href="../index.html" class="logo">
                <span>ðŸ“š Seller Portal</span>
            </a>
            <nav class="sidebar-nav">
                <a href="seller-dashboard.html" class="sidebar-link">Overview</a>
                <a href="inventory.html" class="sidebar-link">My Inventory</a>
                <a href="seller-add-book.html" class="sidebar-link active">Add New Book</a>
                <a href="seller-orders.html" class="sidebar-link">Orders</a>
                <a href="seller-earnings.html" class="sidebar-link">Earnings</a>
                <a href="seller-settings.html" class="sidebar-link">Settings</a>
                <a href="../index.html" class="sidebar-link"
                    style="margin-top: auto; color: var(--error-color);">Logout</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <header class="dashboard-header">
                <div>
                    <h2>Add New Book</h2>
                    <p class="text-light" style="margin: 0;">Create a new listing for your inventory</p>
                </div>
                <div
                    style="display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap; justify-content: flex-end;">
                    <a class="btn btn-outline" href="inventory.html">Back to Inventory</a>
                    <div
                        style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-color), var(--accent-light)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        S</div>
                </div>
            </header>

            <div class="add-book-layout">
                <section class="add-book-card" aria-label="Add book form">
                    <div class="add-book-card-header">
                        <div>
                            <h3 class="add-book-card-title">Book Information</h3>
                            <p class="add-book-card-subtitle">Fill the details carefully. Drafts are saved
                                automatically.</p>
                        </div>
                        <span class="pill" id="draftPill">Draft Saved</span>
                    </div>

                    <div class="add-book-card-body">
                        <form id="addBookForm" novalidate>
                            <div class="form-grid">
                                <div class="form-group span-2">
                                    <label class="form-label" for="title">Book Title *</label>
                                    <input class="form-control" id="title" name="title" type="text"
                                        placeholder="e.g., The Great Gatsby" required maxlength="120">
                                    <div class="error-text" data-error-for="title">Please enter the book title.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="author">Author *</label>
                                    <input class="form-control" id="author" name="author" type="text"
                                        placeholder="e.g., F. Scott Fitzgerald" required maxlength="80">
                                    <div class="error-text" data-error-for="author">Please enter the author name.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="isbn">ISBN</label>
                                    <input class="form-control" id="isbn" name="isbn" type="text"
                                        placeholder="e.g., 978-0743273565" inputmode="numeric" maxlength="20">
                                    <div class="help-text">Optional, but recommended for better search accuracy.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="category">Category *</label>
                                    <select class="form-control" id="category" name="category" required>
                                        <option value="">Select category</option>
                                        <option>Fiction</option>
                                        <option>Non-Fiction</option>
                                        <option>Business</option>
                                        <option>Technology</option>
                                        <option>Biography</option>
                                        <option>Self-Help</option>
                                        <option>History</option>
                                        <option>Children</option>
                                    </select>
                                    <div class="error-text" data-error-for="category">Please select a category.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="language">Language *</label>
                                    <select class="form-control" id="language" name="language" required>
                                        <option value="">Select language</option>
                                        <option>English</option>
                                        <option>Tamil</option>
                                        <option>Hindi</option>
                                        <option>Malayalam</option>
                                        <option>Telugu</option>
                                    </select>
                                    <div class="error-text" data-error-for="language">Please select a language.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="publisher">Publisher</label>
                                    <input class="form-control" id="publisher" name="publisher" type="text"
                                        placeholder="e.g., Scribner" maxlength="80">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="format">Format *</label>
                                    <select class="form-control" id="format" name="format" required>
                                        <option value="">Select format</option>
                                        <option>Paperback</option>
                                        <option>Hardcover</option>
                                        <option>Ebook</option>
                                    </select>
                                    <div class="error-text" data-error-for="format">Please select a format.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="condition">Condition *</label>
                                    <select class="form-control" id="condition" name="condition" required>
                                        <option value="">Select condition</option>
                                        <option>New</option>
                                        <option>Like New</option>
                                        <option>Good</option>
                                        <option>Acceptable</option>
                                    </select>
                                    <div class="error-text" data-error-for="condition">Please select the condition.
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="price">Price (USD) *</label>
                                    <input class="form-control" id="price" name="price" type="number" min="0"
                                        step="0.01" placeholder="e.g., 12.99" required>
                                    <div class="error-text" data-error-for="price">Please enter a valid price.</div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="stock">Stock *</label>
                                    <input class="form-control" id="stock" name="stock" type="number" min="0" step="1"
                                        placeholder="e.g., 20" required>
                                    <div class="error-text" data-error-for="stock">Please enter a valid stock quantity.
                                    </div>
                                </div>

                                <div class="form-group span-2">
                                    <label class="form-label" for="description">Description *</label>
                                    <textarea class="form-control" id="description" name="description"
                                        placeholder="Write a short description about the book..." required
                                        maxlength="1200"></textarea>
                                    <div class="help-text"><span id="descCount">0</span>/1200 characters</div>
                                    <div class="error-text" data-error-for="description">Please add a short description.
                                    </div>
                                </div>

                                <div class="form-group span-2">
                                    <label class="form-label" for="images">Book Images</label>
                                    <div class="upload-zone" id="uploadZone">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
                                            <div>
                                                <div style="font-weight: 800; color: var(--secondary-color);">Upload
                                                    cover images</div>
                                                <div class="help-text">Drag & drop images here, or choose files
                                                    (JPG/PNG/WebP). Up to 3 images.</div>
                                            </div>
                                            <label class="btn btn-outline" style="margin: 0; cursor: pointer;">
                                                Choose Files
                                                <input id="images" name="images" type="file" accept="image/*" multiple
                                                    style="display:none;">
                                            </label>
                                        </div>
                                        <div class="upload-preview" id="uploadPreview" aria-live="polite"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="actions-bar" style="margin-top: var(--spacing-lg);">
                                <button type="button" class="btn btn-outline" id="saveDraftBtn">Save Draft</button>
                                <button type="reset" class="btn btn-outline" id="resetBtn"
                                    style="color: var(--error-color); border-color: var(--error-color);">Clear</button>
                                <button type="submit" class="btn btn-primary" id="publishBtn"
                                    style="background-color: var(--accent-color);">Publish Book</button>
                            </div>
                        </form>
                    </div>
                </section>

                <aside class="meta-list" aria-label="Listing preview">
                    <div class="add-book-card">
                        <div class="add-book-card-header">
                            <div>
                                <h3 class="add-book-card-title">Listing Preview</h3>
                                <p class="add-book-card-subtitle">This updates as you type</p>
                            </div>
                        </div>
                        <div class="add-book-card-body">
                            <div class="meta-item">
                                <p class="meta-title" style="margin-bottom: var(--spacing-md);">Quick Summary</p>
                                <div class="meta-row"><span>Title</span><strong id="prevTitle">â€”</strong></div>
                                <div class="meta-row"><span>Author</span><strong id="prevAuthor">â€”</strong></div>
                                <div class="meta-row"><span>Category</span><strong id="prevCategory">â€”</strong></div>
                                <div class="meta-row"><span>Format</span><strong id="prevFormat">â€”</strong></div>
                                <div class="meta-row"><span>Condition</span><strong id="prevCondition">â€”</strong></div>
                                <div class="meta-row"><span>Price</span><strong id="prevPrice">â€”</strong></div>
                                <div class="meta-row"><span>Stock</span><strong id="prevStock">â€”</strong></div>
                            </div>

                            <div class="meta-item">
                                <p class="meta-title">Tips</p>
                                <p class="text-light" style="margin: 0; line-height: 1.7; font-size: 0.95rem;">
                                    Use a clear title, add ISBN if available, and upload a bright cover image. Accurate
                                    stock helps prevent cancellations.
                                </p>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite">
        <p class="toast-title" id="toastTitle">Saved</p>
        <p class="toast-msg" id="toastMsg">Your draft has been saved.</p>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase.js"></script>
    <script>
        const DRAFT_KEY = 'shelfsync_seller_add_book_draft_v1';

        const form = document.getElementById('addBookForm');
        const desc = document.getElementById('description');
        const descCount = document.getElementById('descCount');
        const draftPill = document.getElementById('draftPill');

        const uploadZone = document.getElementById('uploadZone');
        const imagesInput = document.getElementById('images');
        const uploadPreview = document.getElementById('uploadPreview');

        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMsg = document.getElementById('toastMsg');

        const previewBindings = [
            ['title', 'prevTitle'],
            ['author', 'prevAuthor'],
            ['category', 'prevCategory'],
            ['format', 'prevFormat'],
            ['condition', 'prevCondition'],
            ['price', 'prevPrice', (v) => (v ? `$${Number(v).toFixed(2)}` : 'â€”')],
            ['stock', 'prevStock', (v) => (v ? `${v}` : 'â€”')]
        ];

        let toastTimer = null;

        function showToast(title, message) {
            toastTitle.textContent = title;
            toastMsg.textContent = message;
            toast.classList.add('show');

            if (toastTimer) {
                clearTimeout(toastTimer);
            }

            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 2600);
        }

        function setPill(text, tone) {
            draftPill.textContent = text;
            draftPill.style.borderColor = tone === 'warning' ? 'rgba(196, 86, 33, 0.45)' : 'rgba(56, 161, 105, 0.35)';
            draftPill.style.background = tone === 'warning' ? 'rgba(196, 86, 33, 0.08)' : 'rgba(56, 161, 105, 0.08)';
        }

        function updateCharCount() {
            descCount.textContent = String(desc.value.length);
        }

        function getFormDataObject() {
            const data = {
                title: form.title.value.trim(),
                author: form.author.value.trim(),
                isbn: form.isbn.value.trim(),
                category: form.category.value,
                language: form.language.value,
                publisher: form.publisher.value.trim(),
                format: form.format.value,
                condition: form.condition.value,
                price: form.price.value,
                stock: form.stock.value,
                description: form.description.value.trim(),
                updatedAt: new Date().toISOString()
            };

            return data;
        }

        function setFieldError(fieldId, isError) {
            const input = document.getElementById(fieldId);
            const msg = document.querySelector(`[data-error-for="${fieldId}"]`);

            if (isError) {
                input.classList.add('invalid');
                if (msg) msg.style.display = 'block';
            } else {
                input.classList.remove('invalid');
                if (msg) msg.style.display = 'none';
            }
        }

        function validateForm() {
            const data = getFormDataObject();
            let ok = true;

            const requiredFields = ['title', 'author', 'category', 'language', 'format', 'condition', 'price', 'stock', 'description'];
            requiredFields.forEach((id) => {
                const val = (data[id] ?? '').toString().trim();
                const isError = !val;
                setFieldError(id, isError);
                if (isError) ok = false;
            });

            const priceNum = Number(data.price);
            const stockNum = Number(data.stock);

            if (!Number.isFinite(priceNum) || priceNum <= 0) {
                setFieldError('price', true);
                ok = false;
            }

            if (!Number.isFinite(stockNum) || stockNum < 0) {
                setFieldError('stock', true);
                ok = false;
            }

            return ok;
        }

        function saveDraft(silent = false) {
            const payload = getFormDataObject();
            localStorage.setItem(DRAFT_KEY, JSON.stringify(payload));
            setPill('Draft Saved', 'success');
            if (!silent) {
                showToast('Draft saved', 'Your changes are stored locally on this device.');
            }
        }

        function loadDraft() {
            try {
                const raw = localStorage.getItem(DRAFT_KEY);
                if (!raw) return;

                const data = JSON.parse(raw);
                if (!data || typeof data !== 'object') return;

                form.title.value = data.title ?? '';
                form.author.value = data.author ?? '';
                form.isbn.value = data.isbn ?? '';
                form.category.value = data.category ?? '';
                form.language.value = data.language ?? '';
                form.publisher.value = data.publisher ?? '';
                form.format.value = data.format ?? '';
                form.condition.value = data.condition ?? '';
                form.price.value = data.price ?? '';
                form.stock.value = data.stock ?? '';
                form.description.value = data.description ?? '';

                updateCharCount();
                updatePreview();
                setPill('Draft Loaded', 'warning');
            } catch (_) {
                // ignore bad draft
            }
        }

        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY);
            setPill('Draft Cleared', 'warning');
        }

        function updatePreview() {
            previewBindings.forEach(([fieldId, previewId, mapFn]) => {
                const field = document.getElementById(fieldId);
                const el = document.getElementById(previewId);
                const raw = (field?.value ?? '').toString().trim();

                if (!el) return;

                const display = mapFn ? mapFn(raw) : (raw || 'â€”');
                el.textContent = display;
            });
        }

        function renderImagePreview(files) {
            uploadPreview.innerHTML = '';

            const list = Array.from(files).slice(0, 3);
            if (list.length === 0) return;

            list.forEach((file, idx) => {
                const tile = document.createElement('div');
                tile.className = 'preview-tile';

                const badge = document.createElement('div');
                badge.className = 'preview-badge';
                badge.textContent = idx === 0 ? 'Cover' : `Image ${idx + 1}`;

                const img = document.createElement('img');
                img.alt = file.name;

                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = String(e.target?.result ?? '');
                };
                reader.readAsDataURL(file);

                tile.appendChild(img);
                tile.appendChild(badge);
                uploadPreview.appendChild(tile);
            });
        }

        function setFilesToInput(fileList) {
            const dt = new DataTransfer();
            Array.from(fileList).slice(0, 3).forEach((f) => dt.items.add(f));
            imagesInput.files = dt.files;
            renderImagePreview(imagesInput.files);
        }

        form.addEventListener('input', () => {
            updateCharCount();
            updatePreview();
            setPill('Editingâ€¦', 'warning');
        });

        form.addEventListener('change', () => {
            updatePreview();
            saveDraft(true);
        });

        document.getElementById('saveDraftBtn').addEventListener('click', () => saveDraft(false));

        document.getElementById('resetBtn').addEventListener('click', () => {
            uploadPreview.innerHTML = '';
            clearDraft();
            showToast('Cleared', 'Form and draft have been cleared.');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const ok = validateForm();
            if (!ok) {
                showToast('Missing details', 'Please fill all required fields before publishing.');
                return;
            }

            const btn = document.getElementById('publishBtn');
            const original = btn.innerHTML;
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                // Get form data
                const formData = getFormDataObject();
                
                // Handle image upload
                let imageUrl = null;
                const imageFiles = imagesInput.files;
                
                if (imageFiles && imageFiles.length > 0) {
                    // Check if user is authenticated
                    const { data: { user } } = await window.supabaseClient.auth.getUser();
                    
                    if (!user) {
                        throw new Error('You must be logged in to upload images');
                    }
                    
                    // Upload the first image as the cover
                    const file = imageFiles[0];
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2)}.${fileExt}`;
                    
                    console.log('Uploading image:', fileName);
                    
                    const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                        .from('book-images')
                        .upload(fileName, file);
                    
                    if (uploadError) {
                        console.error('Upload error:', uploadError);
                        throw new Error('Failed to upload image: ' + uploadError.message);
                    }
                    
                    // Get public URL
                    const { data: urlData } = window.supabaseClient.storage
                        .from('book-images')
                        .getPublicUrl(fileName);
                    
                    imageUrl = urlData.publicUrl;
                    console.log('Image uploaded successfully:', imageUrl);
                }
                
                // Prepare book data for database
                const bookData = {
                    title: formData.title,
                    author: formData.author,
                    isbn: formData.isbn || null,
                    category: formData.category,
                    language: formData.language,
                    publisher: formData.publisher || null,
                    format: formData.format,
                    condition: formData.condition,
                    price: parseFloat(formData.price),
                    stock: parseInt(formData.stock),
                    description: formData.description,
                    cover: imageUrl, // Store the public URL
                    created_at: new Date().toISOString()
                };
                
                // Insert book into database
                const { data: insertData, error: insertError } = await window.supabaseClient
                    .from('books')
                    .insert([bookData])
                    .select();
                
                if (insertError) {
                    console.error('Database insert error:', insertError);
                    throw new Error('Failed to save book: ' + insertError.message);
                }
                
                console.log('Book saved successfully:', insertData);
                
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.innerHTML = original;

                clearDraft();
                showToast('Published', 'Your book has been added successfully! Redirecting to inventoryâ€¦');

                setTimeout(() => {
                    window.location.href = 'inventory.html';
                }, 1200);
                
            } catch (error) {
                console.error('Error publishing book:', error);
                
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.innerHTML = original;
                
                showToast('Error', error.message || 'Failed to publish book. Please try again.');
            }
        });

        imagesInput.addEventListener('change', () => {
            renderImagePreview(imagesInput.files);
        });

        ;['dragenter', 'dragover'].forEach((evt) => {
            uploadZone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.add('dragover');
            });
        });

        ;['dragleave', 'drop'].forEach((evt) => {
            uploadZone.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.remove('dragover');
            });
        });

        uploadZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer?.files;
            if (!files || files.length === 0) return;
            setFilesToInput(files);
            showToast('Images added', 'Preview updated. First image will be used as cover.');
        });

        loadDraft();
        updateCharCount();
        updatePreview();
    </script>

    <!-- Authentication Guard -->
    <script src="../js/auth-guard.js"></script>
    <script>
        // Check seller authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuthAndRole('seller');
        });
    </script>
    <script src="seller-add-book.js"></script>
</body>

</html>