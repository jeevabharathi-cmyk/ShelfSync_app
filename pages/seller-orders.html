<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders | Seller Portal</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .dashboard-sidebar {
            background-color: #0f172a;
        }

        .stat-card h3 {
            color: var(--accent-color);
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .filter-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            padding-bottom: var(--spacing-md);
        }

        .filter-tab {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            background: none;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            position: relative;
            font-size: 0.9375rem;
            transition: color var(--transition-base);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .filter-tab::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-color);
            transform: scaleX(0);
            transition: transform var(--transition-base);
        }

        .filter-tab:hover {
            color: var(--primary-color);
        }

        .filter-tab.active {
            color: var(--primary-color);
        }

        .filter-tab.active::after {
            transform: scaleX(1);
        }

        .search-bar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .search-bar .form-control {
            flex: 1;
            max-width: 400px;
        }

        .order-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all var(--transition-base);
            position: relative;
        }

        .order-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-color);
            border-radius: var(--radius-lg) 0 0 var(--radius-lg);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .order-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateX(4px);
            border-color: var(--primary-light);
        }

        .order-card:hover::before {
            opacity: 1;
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .order-info {
            flex: 1;
        }

        .order-id {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--secondary-color);
            margin-bottom: var(--spacing-xs);
            font-family: var(--font-display);
        }

        .order-date {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .order-status-badge {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            font-weight: 600;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background-color: var(--background-color);
            border-radius: var(--radius-md);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8125rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .order-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .order-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-color);
            font-family: var(--font-display);
        }

        @media (max-width: 768px) {
            .order-card-header {
                flex-direction: column;
            }

            .order-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <a href="../index.html" class="logo">
                <span>ðŸ“š Seller Portal</span>
            </a>
            <nav class="sidebar-nav">
                <a href="seller-dashboard.html" class="sidebar-link">Overview</a>
                <a href="inventory.html" class="sidebar-link">My Inventory</a>
                <a href="seller-add-book.html" class="sidebar-link">Add New Book</a>
                <a href="seller-orders.html" class="sidebar-link active">Orders</a>
                <a href="seller-earnings.html" class="sidebar-link">Earnings</a>
                <a href="seller-settings.html" class="sidebar-link">Settings</a>
                <a href="../index.html" class="sidebar-link"
                    style="margin-top: auto; color: var(--error-color);">Logout</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <header class="dashboard-header">
                <div>
                    <h2>Order Management</h2>
                    <p class="text-light" style="margin: 0;">Manage and track all your orders</p>
                </div>
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div
                        style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-color), var(--accent-light)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        S</div>
                </div>
            </header>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-bottom: var(--spacing-xl);">
                <div class="stat-card">
                    <h3>24</h3>
                    <p>Pending Orders</p>
                </div>
                <div class="stat-card">
                    <h3>156</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <h3>12</h3>
                    <p>Shipped Today</p>
                </div>
                <div class="stat-card">
                    <h3>$3,450</h3>
                    <p>This Month</p>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">All Orders</button>
                <button class="filter-tab" data-filter="pending">Pending</button>
                <button class="filter-tab" data-filter="processing">Processing</button>
                <button class="filter-tab" data-filter="shipped">Shipped</button>
                <button class="filter-tab" data-filter="delivered">Delivered</button>
                <button class="filter-tab" data-filter="cancelled">Cancelled</button>
            </div>

            <!-- Search Bar -->
            <div class="search-bar">
                <input id="orderSearch" type="text" class="form-control"
                    placeholder="Search by Order ID, Customer name, or Book title...">
                <button class="btn btn-primary" id="searchBtn">Search</button>
                <button class="btn btn-outline" id="exportBtn">Export</button>
            </div>

            <!-- Orders List -->
            <div id="ordersList"></div>

        </main>
    </div>

    <script>
        const ORDERS_KEY = 'shelfsync_orders_v1';

        const ordersListEl = document.getElementById('ordersList');
        const orderSearchEl = document.getElementById('orderSearch');
        const searchBtn = document.getElementById('searchBtn');
        const exportBtn = document.getElementById('exportBtn');

        const statPending = document.querySelector('.stats-grid .stat-card:nth-child(1) h3');
        const statTotal = document.querySelector('.stats-grid .stat-card:nth-child(2) h3');
        const statShippedToday = document.querySelector('.stats-grid .stat-card:nth-child(3) h3');
        const statThisMonth = document.querySelector('.stats-grid .stat-card:nth-child(4) h3');

        let activeFilter = 'all';
        let activeQuery = '';

        function loadOrders() {
            try {
                const raw = localStorage.getItem(ORDERS_KEY);
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        }

        function saveOrders(orders) {
            localStorage.setItem(ORDERS_KEY, JSON.stringify(Array.isArray(orders) ? orders : []));
        }

        function money(n) {
            return `$${Number(n || 0).toFixed(2)}`;
        }

        function formatDate(iso) {
            try {
                const d = new Date(iso);
                return d.toLocaleString();
            } catch {
                return '';
            }
        }

        function statusBadgeClass(status) {
            const s = String(status || '').toLowerCase();
            if (s === 'pending') return 'badge badge-warning order-status-badge';
            if (s === 'processing') return 'badge badge-primary order-status-badge';
            if (s === 'shipped') return 'badge badge-success order-status-badge';
            if (s === 'delivered') return 'badge badge-success order-status-badge';
            if (s === 'cancelled') return 'badge badge-error order-status-badge';
            return 'badge badge-primary order-status-badge';
        }

        function firstItemSummary(order) {
            const items = Array.isArray(order?.items) ? order.items : [];
            if (items.length === 0) return { title: 'â€”', qty: 0 };
            const qty = items.reduce((s, i) => s + (Number(i.qty) || 0), 0);
            const title = String(items[0]?.title || 'Book');
            return { title, qty };
        }

        function matchesQuery(order, query) {
            const q = String(query || '').trim().toLowerCase();
            if (!q) return true;

            const id = String(order?.id || '').toLowerCase();
            const customer = String(order?.delivery?.fullName || '').toLowerCase();
            const items = Array.isArray(order?.items) ? order.items : [];
            const titles = items.map(i => String(i?.title || '').toLowerCase()).join(' ');
            return id.includes(q) || customer.includes(q) || titles.includes(q);
        }

        function filterOrders(orders) {
            const filtered = orders
                .filter((o) => {
                    if (activeFilter === 'all') return true;
                    return String(o?.status || '').toLowerCase() === activeFilter;
                })
                .filter((o) => matchesQuery(o, activeQuery));
            return filtered;
        }

        function updateStats(allOrders) {
            const orders = Array.isArray(allOrders) ? allOrders : [];
            const pending = orders.filter(o => String(o?.status || '').toLowerCase() === 'pending').length;
            const total = orders.length;

            const today = new Date();
            const isToday = (iso) => {
                try {
                    const d = new Date(iso);
                    return d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate();
                } catch {
                    return false;
                }
            };

            const shippedToday = orders.filter(o => String(o?.status || '').toLowerCase() === 'shipped' && isToday(o?.shipment?.shippedAt)).length;

            const monthTotal = orders
                .filter((o) => {
                    try {
                        const d = new Date(o?.createdAt);
                        return d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth();
                    } catch {
                        return false;
                    }
                })
                .reduce((s, o) => s + (Number(o?.totals?.total) || 0), 0);

            if (statPending) statPending.textContent = String(pending);
            if (statTotal) statTotal.textContent = String(total);
            if (statShippedToday) statShippedToday.textContent = String(shippedToday);
            if (statThisMonth) statThisMonth.textContent = money(monthTotal);
        }

        function setFilter(next) {
            activeFilter = next;
            document.querySelectorAll('.filter-tab').forEach((btn) => {
                btn.classList.toggle('active', btn.dataset.filter === next);
            });
            render();
        }

        function render() {
            const allOrders = loadOrders();
            updateStats(allOrders);

            const orders = filterOrders(allOrders);
            ordersListEl.innerHTML = '';

            if (orders.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'order-card';
                empty.innerHTML = `
                    <div class="order-card-header">
                        <div class="order-info">
                            <div class="order-id">No orders found</div>
                            <div class="order-date">Try changing filters or place a new order from the cart.</div>
                        </div>
                        <div><span class="badge badge-primary order-status-badge">Empty</span></div>
                    </div>
                    <div class="order-actions">
                        <button class="btn btn-outline btn-sm" onclick="seedDemoOrders()">Seed Demo Orders</button>
                    </div>
                `;
                ordersListEl.appendChild(empty);
                return;
            }

            orders.forEach((order) => {
                const card = document.createElement('div');
                card.className = 'order-card';

                const summary = firstItemSummary(order);
                const total = Number(order?.totals?.total) || 0;

                const tracking = String(order?.shipment?.trackingNumber || '').trim();
                const trackingText = tracking ? tracking : 'â€”';

                card.innerHTML = `
                    <div class="order-card-header">
                        <div class="order-info">
                            <div class="order-id">#${order.id || ''}</div>
                            <div class="order-date">Ordered on ${formatDate(order.createdAt)}</div>
                        </div>
                        <div>
                            <span class="${statusBadgeClass(order.status)}">${String(order.status || 'Pending')}</span>
                        </div>
                    </div>
                    <div class="order-details">
                        <div class="detail-item">
                            <span class="detail-label">Customer</span>
                            <span class="detail-value">${String(order?.delivery?.fullName || 'â€”')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Book</span>
                            <span class="detail-value">${summary.title}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Quantity</span>
                            <span class="detail-value">${String(summary.qty || 0)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Tracking</span>
                            <span class="detail-value">${trackingText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total Amount</span>
                            <span class="order-total">${money(total)}</span>
                        </div>
                    </div>
                    <div class="order-actions"></div>
                `;

                const actions = card.querySelector('.order-actions');
                const shipTrack = document.createElement('a');
                shipTrack.className = 'btn btn-primary btn-sm';
                shipTrack.href = `ship-track-details.html?orderId=${encodeURIComponent(order.id || '')}`;
                shipTrack.textContent = 'Ship & Track';

                const markProcessing = document.createElement('button');
                markProcessing.className = 'btn btn-outline btn-sm';
                markProcessing.type = 'button';
                markProcessing.textContent = 'Processing';
                markProcessing.addEventListener('click', () => {
                    const orders = loadOrders();
                    const idx = orders.findIndex(o => o.id === order.id);
                    if (idx >= 0) {
                        orders[idx].status = 'Processing';
                        saveOrders(orders);
                        render();
                    }
                });

                const cancel = document.createElement('button');
                cancel.className = 'btn btn-outline btn-sm';
                cancel.type = 'button';
                cancel.textContent = 'Cancel';
                cancel.style.color = 'var(--error-color)';
                cancel.style.borderColor = 'var(--error-color)';
                cancel.addEventListener('click', () => {
                    const orders = loadOrders();
                    const idx = orders.findIndex(o => o.id === order.id);
                    if (idx >= 0) {
                        orders[idx].status = 'Cancelled';
                        saveOrders(orders);
                        render();
                    }
                });

                actions.appendChild(shipTrack);
                actions.appendChild(markProcessing);
                actions.appendChild(cancel);
                ordersListEl.appendChild(card);
            });
        }

        document.querySelectorAll('.filter-tab').forEach((btn) => {
            btn.addEventListener('click', () => setFilter(btn.dataset.filter));
        });

        searchBtn.addEventListener('click', () => {
            activeQuery = (orderSearchEl.value || '').trim();
            render();
        });

        orderSearchEl.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            activeQuery = (orderSearchEl.value || '').trim();
            render();
        });

        exportBtn.addEventListener('click', () => {
            const data = filterOrders(loadOrders());
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'orders-export.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        });

        function seedDemoOrders() {
            try {
                const demoOrders = [
                    {
                        id: `ORD-${Date.now() - 86400000}`,
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        status: 'Pending',
                        items: [{ title: 'Atomic Habits', price: 16.99, qty: 1 }],
                        totals: { subtotal: 16.99, delivery: 2.0, tax: 0.85, total: 19.84 },
                        payment: { method: 'gpay' },
                        delivery: { fullName: 'Alice Johnson', phone: '+91 98765 43210', address: '123 Main St', city: 'Mumbai', pincode: '400001' },
                        shipment: { carrier: '', trackingNumber: '', shippedAt: null, deliveredAt: null, notes: '' }
                    },
                    {
                        id: `ORD-${Date.now() - 172800000}`,
                        createdAt: new Date(Date.now() - 172800000).toISOString(),
                        status: 'Processing',
                        items: [{ title: 'Deep Work', price: 14.50, qty: 2 }],
                        totals: { subtotal: 29.00, delivery: 2.0, tax: 1.45, total: 32.45 },
                        payment: { method: 'upi' },
                        delivery: { fullName: 'Bob Smith', phone: '+91 87654 32109', address: '456 Oak Ave', city: 'Delhi', pincode: '110001' },
                        shipment: { carrier: '', trackingNumber: '', shippedAt: null, deliveredAt: null, notes: '' }
                    },
                    {
                        id: `ORD-${Date.now() - 259200000}`,
                        createdAt: new Date(Date.now() - 259200000).toISOString(),
                        status: 'Shipped',
                        items: [{ title: 'The Alchemist', price: 12.99, qty: 1 }],
                        totals: { subtotal: 12.99, delivery: 2.0, tax: 0.65, total: 15.64 },
                        payment: { method: 'card' },
                        delivery: { fullName: 'Charlie Brown', phone: '+91 76543 21098', address: '789 Pine Rd', city: 'Bangalore', pincode: '560001' },
                        shipment: { carrier: 'DTDC', trackingNumber: 'DT123456789', shippedAt: new Date(Date.now() - 86400000).toISOString(), deliveredAt: null, notes: '' }
                    },
                    {
                        id: `ORD-${Date.now() - 345600000}`,
                        createdAt: new Date(Date.now() - 345600000).toISOString(),
                        status: 'Delivered',
                        items: [{ title: 'Clean Code', price: 35.00, qty: 1 }],
                        totals: { subtotal: 35.00, delivery: 2.0, tax: 1.75, total: 38.75 },
                        payment: { method: 'gpay' },
                        delivery: { fullName: 'Diana Prince', phone: '+91 65432 10987', address: '321 Elm St', city: 'Chennai', pincode: '600001' },
                        shipment: { carrier: 'BlueDart', trackingNumber: 'BD987654321', shippedAt: new Date(Date.now() - 259200000).toISOString(), deliveredAt: new Date(Date.now() - 172800000).toISOString(), notes: '' }
                    },
                    {
                        id: `ORD-${Date.now() - 432000000}`,
                        createdAt: new Date(Date.now() - 432000000).toISOString(),
                        status: 'Cancelled',
                        items: [{ title: 'Design Patterns', price: 42.00, qty: 1 }],
                        totals: { subtotal: 42.00, delivery: 2.0, tax: 2.10, total: 46.10 },
                        payment: { method: 'upi' },
                        delivery: { fullName: 'Eve Wilson', phone: '+91 54321 09876', address: '654 Maple Dr', city: 'Kolkata', pincode: '700001' },
                        shipment: { carrier: '', trackingNumber: '', shippedAt: null, deliveredAt: null, notes: 'Customer requested cancellation' }
                    }
                ];

                const existingOrders = loadOrders();
                const combinedOrders = [...demoOrders, ...existingOrders];
                saveOrders(combinedOrders);
                render();
            } catch (error) {
                console.error('Error seeding demo orders:', error);
                alert('Failed to seed demo orders. Please try again.');
            }
        }

        render();
    </script>

</body>

</html>