<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShelfSync | Firestore Migration Tool</title>
    <link rel="stylesheet" href="css/shelf-sync-all.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <style>
        .migration-card {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .progress-container {
            margin: 20px 0;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        #status {
            margin-top: 15px;
            font-weight: 600;
        }

        .log-container {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="migration-card">
            <h2>üöÄ Firestore Migration Tool</h2>
            <p>This tool will upload your local books database to Firebase Firestore.</p>

            <div id="configCheck" style="margin: 20px 0; padding: 15px; border-radius: 8px;">
                Checking Firebase Configuration...
            </div>

            <button id="startBtn" class="btn btn-primary" disabled>Start Migration</button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div id="status">Ready to start</div>

            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const logContainer = document.getElementById('logContainer');
        const configCheck = document.getElementById('configCheck');

        // Check if config is valid
        if (firebaseConfig.apiKey === "YOUR_API_KEY") {
            configCheck.innerHTML = "‚ùå <strong>Error:</strong> Please update <code>js/firebase-config.js</code> with your actual Firebase credentials first.";
            configCheck.style.backgroundColor = "#ffebee";
            configCheck.style.color = "#c62828";
        } else {
            configCheck.innerHTML = "‚úÖ Firebase Configuration detected!";
            configCheck.style.backgroundColor = "#e8f5e9";
            configCheck.style.color = "#2e7d32";
            startBtn.disabled = false;
        }

        function log(msg) {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
            logContainer.style.display = 'block';
        }

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            progressContainer.style.display = 'block';
            status.textContent = "Loading local database...";

            try {
                const response = await fetch('books-database.json');
                const data = await response.json();
                const books = data.books;
                const total = books.length;

                status.textContent = `Found ${total} books. Starting upload...`;
                log(`Starting migration of ${total} books...`);

                let count = 0;
                const batchSize = 500; // Firestore batch limit

                for (let i = 0; i < total; i += batchSize) {
                    const batch = db.batch();
                    const chunk = books.slice(i, i + batchSize);

                    chunk.forEach(book => {
                        // Use ISBN as document ID if available, otherwise auto-ID
                        const docRef = book.isbn ? db.collection('books').doc(book.isbn) : db.collection('books').doc();
                        batch.set(docRef, book);
                    });

                    await batch.commit();
                    count += chunk.length;

                    const percent = Math.round((count / total) * 100);
                    progressBar.style.width = `${percent}%`;
                    status.textContent = `Uploaded ${count} of ${total} books (${percent}%)`;
                    log(`Batch committed: ${count}/${total}`);
                }

                status.textContent = "‚úÖ Migration Complete!";
                status.style.color = "#2e7d32";
                log("Migration finished successfully!");
                alert("Migration Complete! Your books are now in Firestore.");

            } catch (error) {
                console.error(error);
                status.textContent = "‚ùå Error during migration";
                status.style.color = "#c62828";
                log(`ERROR: ${error.message}`);
                startBtn.disabled = false;
            }
        });
    </script>
</body>

</html>