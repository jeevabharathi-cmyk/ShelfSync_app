<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Setup & Test | ShelfSync</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #2c5282;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
        }

        .test-section {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .test-section h3 {
            margin-top: 0;
            color: #2d3748;
        }

        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.pending {
            background: #fef5e7;
            color: #e67e22;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #48bb78;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .log {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .log-entry {
            margin: 5px 0;
        }

        .log-error {
            color: #fc8181;
        }

        .log-success {
            color: #68d391;
        }

        .log-info {
            color: #63b3ed;
        }

        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üî• Firebase Setup & Connection Test</h1>
        <p class="subtitle">Initialize and verify your Firebase backend connections</p>

        <!-- Authentication Test -->
        <div class="test-section">
            <h3>1Ô∏è‚É£ Firebase Authentication</h3>
            <div id="authStatus" class="status pending">‚è≥ Not tested yet</div>
            <button onclick="testAuth()" class="btn">Test Authentication</button>
            <div id="authDetails" style="margin-top: 10px;"></div>
        </div>

        <!-- Firestore Test -->
        <div class="test-section">
            <h3>2Ô∏è‚É£ Cloud Firestore Database</h3>
            <div id="firestoreStatus" class="status pending">‚è≥ Not tested yet</div>
            <button onclick="testFirestore()" class="btn">Test Firestore Connection</button>
            <button onclick="initializeDatabase()" class="btn btn-success">Initialize Database</button>
            <div id="firestoreDetails" style="margin-top: 10px;"></div>
        </div>

        <!-- User Creation Test -->
        <div class="test-section">
            <h3>3Ô∏è‚É£ Create Test User Profile</h3>
            <p>This will create a seller profile for jackdoe628@gmail.com in Firestore</p>
            <div id="userStatus" class="status pending">‚è≥ Not created yet</div>
            <button onclick="createTestUser()" class="btn btn-success">Create Test Seller Profile</button>
            <div id="userDetails" style="margin-top: 10px;"></div>
        </div>

        <!-- Live Data Test -->
        <div class="test-section">
            <h3>4Ô∏è‚É£ Fetch Live Data</h3>
            <button onclick="fetchAllUsers()" class="btn">Fetch All Users</button>
            <button onclick="fetchAllSellers()" class="btn">Fetch All Sellers</button>
            <button onclick="fetchBooks()" class="btn">Fetch Books</button>
            <div id="dataDisplay" class="log" style="margin-top: 10px; display: none;"></div>
        </div>

        <!-- Console Log -->
        <div class="test-section">
            <h3>üìù Activity Log</h3>
            <div id="consoleLog" class="log"></div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { onAuthStateChanged, createUserWithEmailAndPassword } from 'firebase/auth';
        import { collection, getDocs, doc, setDoc, getDoc } from 'firebase/firestore';

        window.auth = auth;
        window.db = db;
        window.firestoreModules = { collection, getDocs, doc, setDoc, getDoc };
        window.authModules = { onAuthStateChanged, createUserWithEmailAndPassword };

        // Logging function
        window.logMessage = (message, type = 'info') => {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : 'log-info';
            logDiv.innerHTML += `<div class="log-entry ${logClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        };

        // Test Authentication
        window.testAuth = async () => {
            logMessage('Testing Firebase Authentication...', 'info');
            const statusDiv = document.getElementById('authStatus');
            const detailsDiv = document.getElementById('authDetails');

            try {
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            statusDiv.className = 'status success';
                            statusDiv.textContent = '‚úÖ Authentication Connected';
                            detailsDiv.innerHTML = `<pre>Logged in as: ${user.email}\nUID: ${user.uid}</pre>`;
                            logMessage(`Authentication working! Logged in as: ${user.email}`, 'success');
                        } else {
                            statusDiv.className = 'status success';
                            statusDiv.textContent = '‚úÖ Authentication Connected (Not logged in)';
                            detailsDiv.innerHTML = `<pre>No user currently logged in, but auth service is working.</pre>`;
                            logMessage('Authentication service is working. No user logged in.', 'success');
                        }
                        resolve();
                    });
                });
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Authentication Failed';
                detailsDiv.innerHTML = `<pre>Error: ${error.message}</pre>`;
                logMessage(`Authentication error: ${error.message}`, 'error');
            }
        };

        // Test Firestore
        window.testFirestore = async () => {
            logMessage('Testing Cloud Firestore connection...', 'info');
            const statusDiv = document.getElementById('firestoreStatus');
            const detailsDiv = document.getElementById('firestoreDetails');

            try {
                // Try to fetch a collection
                const testCollection = collection(db, 'users');
                const snapshot = await getDocs(testCollection);

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Firestore Connected';
                detailsDiv.innerHTML = `<pre>Successfully connected to Firestore!\nFound ${snapshot.size} documents in 'users' collection.</pre>`;
                logMessage(`Firestore connected! Found ${snapshot.size} users.`, 'success');
            } catch (error) {
                if (error.code === 'not-found' || error.message.includes('database (default) does not exist')) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Database Not Initialized';
                    detailsDiv.innerHTML = `<pre>Error: The Firestore database has not been created yet.\n\nüìù Instructions:\n1. Go to https://console.firebase.google.com/\n2. Select project: shelfsync-6fedf\n3. Click "Firestore Database" in the left menu\n4. Click "Create Database"\n5. Choose a location (nam5 - us-central)\n6. Start in "Test Mode" or use your existing rules\n7. Click "Create"\n\nOnce created, click "Initialize Database" button above.</pre>`;
                    logMessage('Database not found. Please create it in Firebase Console.', 'error');
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '‚ùå Firestore Error';
                    detailsDiv.innerHTML = `<pre>Error: ${error.message}</pre>`;
                    logMessage(`Firestore error: ${error.message}`, 'error');
                }
            }
        };

        // Initialize Database with collections
        window.initializeDatabase = async () => {
            logMessage('Initializing database collections...', 'info');
            const statusDiv = document.getElementById('firestoreStatus');
            const detailsDiv = document.getElementById('firestoreDetails');

            try {
                // Create a test document in users collection
                await setDoc(doc(db, 'users', 'test-init'), {
                    role: 'test',
                    createdAt: new Date(),
                    purpose: 'Database initialization'
                });

                // Create a test document in sellers collection
                await setDoc(doc(db, 'sellers', 'test-init'), {
                    role: 'seller',
                    createdAt: new Date(),
                    purpose: 'Database initialization'
                });

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Database Initialized';
                detailsDiv.innerHTML = `<pre>Successfully created test documents in:\n- users collection\n- sellers collection\n\nYour database is now ready!</pre>`;
                logMessage('Database initialized with test collections!', 'success');
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Initialization Failed';
                detailsDiv.innerHTML = `<pre>Error: ${error.message}\n\nPlease create the database in Firebase Console first.</pre>`;
                logMessage(`Initialization error: ${error.message}`, 'error');
            }
        };

        // Create test user profile
        window.createTestUser = async () => {
            logMessage('Creating test seller profile...', 'info');
            const statusDiv = document.getElementById('userStatus');
            const detailsDiv = document.getElementById('userDetails');

            try {
                // Get current user or use test UID
                const user = auth.currentUser;
                const testUID = user ? user.uid : 'test-seller-uid-001';
                const testEmail = user ? user.email : 'jackdoe628@gmail.com';

                // Create seller profile
                await setDoc(doc(db, 'sellers', testUID), {
                    email: testEmail,
                    role: 'seller',
                    createdAt: new Date(),
                    storeName: 'Test Bookstore',
                    verified: true
                });

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Test User Created';
                detailsDiv.innerHTML = `<pre>Created seller profile:\nEmail: ${testEmail}\nUID: ${testUID}\nRole: seller\n\nYou can now log in with this account!</pre>`;
                logMessage(`Seller profile created for ${testEmail}`, 'success');
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå User Creation Failed';
                detailsDiv.innerHTML = `<pre>Error: ${error.message}</pre>`;
                logMessage(`User creation error: ${error.message}`, 'error');
            }
        };

        // Fetch all users
        window.fetchAllUsers = async () => {
            logMessage('Fetching all users...', 'info');
            const dataDiv = document.getElementById('dataDisplay');
            dataDiv.style.display = 'block';

            try {
                const usersCol = collection(db, 'users');
                const snapshot = await getDocs(usersCol);

                let output = `üìÅ Users Collection (${snapshot.size} documents):\n\n`;
                snapshot.forEach((doc) => {
                    output += `ID: ${doc.id}\n${JSON.stringify(doc.data(), null, 2)}\n\n`;
                });

                dataDiv.textContent = output || 'No users found.';
                logMessage(`Fetched ${snapshot.size} users`, 'success');
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
                logMessage(`Fetch users error: ${error.message}`, 'error');
            }
        };

        // Fetch all sellers
        window.fetchAllSellers = async () => {
            logMessage('Fetching all sellers...', 'info');
            const dataDiv = document.getElementById('dataDisplay');
            dataDiv.style.display = 'block';

            try {
                const sellersCol = collection(db, 'sellers');
                const snapshot = await getDocs(sellersCol);

                let output = `üìÅ Sellers Collection (${snapshot.size} documents):\n\n`;
                snapshot.forEach((doc) => {
                    output += `ID: ${doc.id}\n${JSON.stringify(doc.data(), null, 2)}\n\n`;
                });

                dataDiv.textContent = output || 'No sellers found.';
                logMessage(`Fetched ${snapshot.size} sellers`, 'success');
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
                logMessage(`Fetch sellers error: ${error.message}`, 'error');
            }
        };

        // Fetch books
        window.fetchBooks = async () => {
            logMessage('Fetching books...', 'info');
            const dataDiv = document.getElementById('dataDisplay');
            dataDiv.style.display = 'block';

            try {
                const booksCol = collection(db, 'books');
                const snapshot = await getDocs(booksCol);

                let output = `üìö Books Collection (${snapshot.size} documents):\n\n`;
                snapshot.forEach((doc) => {
                    const book = doc.data();
                    output += `üìñ ${book.title || 'Untitled'} by ${book.author || 'Unknown'}\n`;
                });

                dataDiv.textContent = output || 'No books found.';
                logMessage(`Fetched ${snapshot.size} books`, 'success');
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
                logMessage(`Fetch books error: ${error.message}`, 'error');
            }
        };

        // Auto-run auth test on load
        window.addEventListener('load', () => {
            logMessage('Firebase Setup Tool loaded', 'info');
            testAuth();
        });
    </script>
</body>

</html>